# Socket

[即时通讯-IM](#即时通讯-IM)  
[相关文章](#相关文章)

## <a id="即时通讯-IM"></a> 即时通讯-IM
### IM_应用场景: 
一切高实时性的场景，都适合使用IM来做:
	
	视频会议、聊天、私信
	弹幕、抽奖
	互动游戏
	协同编辑
	股票基金实时报价、体育实况更新、
	基于位置的应用：Uber、滴滴司机位置
	在线教育
	智能家居

### IM_发展史
##### 1.(短)轮询
频繁的一问一答 (一般网络请求: 一问一答)  
##### 2.长轮询
耐心地一问一答  
一种轮询方式是否为长轮询，是根据`服务端的处理方式`来决定的，与客户端没有关系。  

长轮询和短轮询最大的区别:  

	短轮询: 去服务端查询的时候，不管服务端有没有变化，服务器就立即返回结果了。  
	长轮询: 服务器如果检测到库存量没有变化的话，将会把当前请求挂起一段时间（这个时间也叫作超时时间，一般是几十秒）。在这个时间里，服务器会去检测库存量有没有变化，检测到变化就立即返回，否则就一直等到超时为止.

##### 3.长连接 (HTML5 WebSocket: 双向)
WebSocket 是 HTML5 开始提供的一种浏览器与服务器间进行全双工通讯的网络技术。  
在 WebSocket API 中，浏览器和服务器只需要要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。

#### 总结: 轮询与长连接
发展历史：从长短轮询到长连接，使用 WebSocket 来替代 HTTP;  
移动端长连接是趋势, 最大的特点是节省 Header 所消耗的流量;

长短轮询与长短连接的主要区别:

    概念范畴不同：长短轮询是应用层概念, 长短连接是传输层概念
    协商方式不同：一种轮询方式是否为长轮询，是根据服务端的处理方式来决定的，与客户端没有关系。一个 TCP 连接是否为长连接，是通过设置 HTTP 的 Connection Header 来决定的，而且是需要两边都设置才有效。
    实现方式不同：轮询的长短，是服务器通过编程的方式手动挂起请求来实现的。连接的长短,是通过协议来规定和实现的。

长连接实现方式里的协议选择:
常见的协议有：XMPP、SIP、MQTT、私有协议。

	XMPP 	优点：协议开源，可拓展性强，在各个端(包括服务器)有各种语言的实现，开发者接入方便； 
	    	缺点：缺点也是不少，XML表现力弱、有太多冗余信息、流量大，实际使用时有大量天坑。
	    	
	MQTT 	优点：协议简单，流量少；订阅+推送模式，非常适合Uber、滴滴的小车轨迹的移动。
		 	缺点：它并不是一个专门为 IM 设计的协议，多使用于推送。IM 情景要复杂得多，pub、sub，比如：加入对话、创建对话等等事件。
		 	
	私有协议 市面上几乎所有主流IM APP都是是使用私有协议，一个被良好设计的私有协议优点非常明显。
	  		优点：高效，节约流量(一般使用二进制协议)，安全性高，难以破解； 
			缺点：在开发初期没有现有样列可以参考，对于设计者的要求比较高。

### IM_数据传输格式
主要是JSON 、ProtocolBuffer、XML ...

ProtocolBuffer 优势:
	
	1.使用 ProtocolBuffer 减少 Payload
    滴滴打车40%；
    携程之前分享过，说是采用新的Protocol Buffer数据格式+Gzip压缩后的Payload大小降低了15%-45%。数据序列化耗时下降了80%-90%。

	2.采用高效安全的私有协议，支持长连接的复用，稳定省电省流量
	【高效】提高网络请求成功率，消息体越大，失败几率随之增加。
	【省流量】流量消耗极少，省流量。一条消息数据用Protobuf序列化后的大小是 JSON 的1/10、XML格式的1/20、是二进制序列化的1/10。同 XML 相比， Protobuf 性能优势明显。它以高效的二进制方式存储，比 XML 小 3 到 10 倍，快 20 到 100 倍。
	【省电】省电
	【高效心跳包】同时心跳包协议对IM的电量和流量影响很大，对心跳包协议上进行了极简设计：仅 1 Byte 。
	【易于使用】开发人员通过按照一定的语法定义结构化的消息格式，然后送给命令行工具，工具将自动生成相关的类，可以支持java、c++、python、Objective-C等语言环境。通过将这些类包含在项目中，可以很轻松的调用相关方法来完成业务消息的序列化与反序列化工作。语言支持：原生支持c++、java、python、Objective-C等多达10余种语言。 2015-08-27 Protocol Buffers v3.0.0-beta-1中发布了Objective-C(Alpha)版本， 2016-07-28 3.0 Protocol Buffers v3.0.0正式版发布，正式支持 Objective-C。
	【可靠】微信和手机 QQ 这样的主流 IM 应用也早已在使用它（采用的是改造过的Protobuf协议）

ProtocolBuffer 缺点：

	1.可能会造成 APP 的包体积增大，通过 Google 提供的脚本生成的 Model，会非常“庞大”，Model 一多，包体积也就会跟着变大。	
	2.如果 Model 过多，可能导致 APP 打包后的体积骤增，但 IM 服务所使用的 Model 非常少，比如在 ChatKit-OC 中只用到了一个 Protobuf 的 Model：Message对象，对包体积的影响微乎其微。
	3.在使用过程中要合理地权衡包体积以及传输效率的问题，据说去哪儿网，就曾经为了减少包体积，进而减少了 Protobuf 的使用。






### 实现方式:  

#### 1.使用第三方IM服务  
	类似LeanCloud、环信、融云、云信 ... 
	底层协议基本上都是TCP, 方案成熟
	缺点: 定制化程度太高, 贵. 若IM非主要功能, 辅助功能, 可考虑.

#### 2.自己实现



## <a id="相关文章"></a>相关文章
[关于iOS socket都在这里了](http://www.cocoachina.com/ios/20160602/16572.html)

[IM 即时通讯技术在多应用场景下的技术实现，以及性能调优（iOS视角）](http://www.jianshu.com/p/8cd908148f9e)  

[微信,QQ这类IM app怎么做——谈谈Websocket](http://www.jianshu.com/p/bcefda55bce4)

[《基于HTTP2的全新APNs协议》](https://github.com/ChenYilong/iOS9AdaptationTips/blob/master/%E5%9F%BA%E4%BA%8EHTTP2%E7%9A%84%E5%85%A8%E6%96%B0APNs%E5%8D%8F%E8%AE%AE/%E5%9F%BA%E4%BA%8EHTTP2%E7%9A%84%E5%85%A8%E6%96%B0APNs%E5%8D%8F%E8%AE%AE.md)  

